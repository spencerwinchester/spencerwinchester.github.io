<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  html, body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;
    background:#fff;
    margin:0;
    width:600px;
    max-width:600px;
    overflow-x:hidden;
    color:#000;
  }
  .container{
    width:600px;
    max-width:600px;
    margin:0 auto;
    padding:0 0 16px;
    box-sizing:border-box;
  }
  h2{font-size:1rem;margin:12px 0 6px;color:#1c75bc;}
  table{
    width:100%;
    border-collapse:separate;
    border-spacing:0 2px;
    margin-bottom:12px;
    font-size:0.85rem;
  }
  th,td{
    border:none;
    padding:4px 2px;
    text-align:center;
    vertical-align:middle;
  }
  th:first-child, td:first-child{
    text-align:left;
    width:25%;
  }
  th:nth-child(2), td:nth-child(2),
  th:nth-child(3), td:nth-child(3){width:37.5%;}
  th:last-child{width:42px}
  td.task-cell{
    position:relative;
    min-height:40px;
  }
  select,
  input[type="text"]{
    width:100%;
    height:40px;
    min-height:40px;
    padding:0 12px;
    border-radius:6px;
    border:1px solid #d6e6f6;
    font-size:0.85rem;
    box-sizing:border-box;
    background:#fff;
  }
  .other-task{
    display:none;
    position:absolute;
    top:4px;
    left:0;
    right:0;
    height:40px;
    min-height:40px;
  }
  .other-task.is-active{display:block;}
  .task-select.other-hidden{visibility:hidden;}
  button.add-row{
    padding:10px 14px;
    margin:10px 0;
    border-radius:6px;
    border:0;
    background:#AFBACE;
    color:#fff;
    cursor:pointer;
    font-size:0.85rem;
  }
  td.actions{
    padding:4px 0;
    display:flex;
    align-items:center;
    justify-content:center;
    width:42px;
  }
  tr.disabled-row td:nth-child(2),
  tr.disabled-row td:nth-child(3){position:relative;}
  tr.disabled-row td:nth-child(2) input,
  tr.disabled-row td:nth-child(3) input{visibility:hidden;}
  tr.disabled-row td:nth-child(2)::after,
  tr.disabled-row td:nth-child(3)::after{
    content:'-';
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    width:100%;
    height:40px;
    line-height:40px;
    border:1px solid #d1d5db;
    border-radius:6px;
    background:#f3f4f6;
    color:#6b7280;
    text-align:center;
    pointer-events:none;
    box-sizing:border-box;
  }
  .delete-row{
    background:#dc3545;
    color:#fff;
    border:none;
    border-radius:6px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:40px;
    height:40px;
    padding:0;
    cursor:pointer;
  }
  .delete-row svg{
    width:16px;
    height:16px;
    fill:currentColor;
  }
</style>
</head>
<body>
<div class="container">
  <div id="tables-container"></div>
</div>

<script>
const categories = [
  {
    name: "",
    tasks: [
        "Mowing the lawn",
        "Watering the plants",
        "Whipper-snipping",
        "Weeding",
        "Gardening",
        "General yard maintenance",
        "Pool maintenance",
        "Trimming hedges or bushes",
        "Raking leaves",
        "Clearing debris",
        "Pruning trees or bushes",
        "Fertilising lawn or garden",
        "Pest or disease control",
        "using garden tools or machinery",
        "Mulching",
        "Other"
    ]
  }
];

const storageKey = 'adlYardMaintenance';
let isRestoring = false;

function rowTemplate(catIndex, rowNumber){
  const tasks = categories[catIndex]?.tasks || [];
  return `
        <tr>
          <td class="task-cell">
            <select name="task_${catIndex}_${rowNumber}" class="task-select">
              <option value="" disabled selected>-- Select --</option>
              ${tasks.map(t => `<option value="${t}">${t}</option>`).join('')}
            </select>
            <input type="text" placeholder="Please enter task" class="other-task" disabled>
          </td>
          <td><input type="text" name="before_${catIndex}_${rowNumber}"></td>
          <td><input type="text" name="current_${catIndex}_${rowNumber}"></td>
          <td class="actions">
            <button type="button" class="delete-row" aria-label="Delete row">
              <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                <path d="M9 3a1 1 0 0 0-.894.553L7.382 5H5a1 1 0 1 0 0 2h14a1 1 0 1 0 0-2h-2.382l-.724-1.447A1 1 0 0 0 14.999 3H9Zm-3 6v10a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V9H6Zm4 2a1 1 0 0 1 2 0v8a1 1 0 1 1-2 0v-8Zm4-1a1 1 0 0 1 1 1v8a1 1 0 1 1-2 0v-8a1 1 0 0 1 1-1Z"/>
              </svg>
            </button>
          </td>
        </tr>
  `;
}

function appendTaskRow(catIndex){
  const index = Number(catIndex);
  const tbody = document.querySelector(`#table_${index} tbody`);
  if (!tbody) return null;
  const rowNumber = tbody.rows.length + 1;
  tbody.insertAdjacentHTML('beforeend', rowTemplate(index, rowNumber));
  return tbody.lastElementChild;
}

function resetTaskRow(tr){
  if (!tr) return;
  tr.classList.remove('disabled-row');
  const select = tr.querySelector('.task-select');
  if (select){
    select.value = '';
    select.classList.remove('other-hidden');
  }
  const other = tr.querySelector('.other-task');
  if (other){
    other.value = '';
    other.disabled = true;
    other.classList.remove('is-active');
  }
  const beforeInput = tr.querySelector('td:nth-child(2) input');
  if (beforeInput){
    beforeInput.value = '';
    beforeInput.disabled = false;
  }
  const currentInput = tr.querySelector('td:nth-child(3) input');
  if (currentInput){
    currentInput.value = '';
    currentInput.disabled = false;
  }
}

function getCatIndexFromName(name){
  const match = name ? name.match(/^task_(\d+)_/) : null;
  return match ? Number(match[1]) : null;
}

function updateTaskOptions(catIndex){
  if (catIndex === null || catIndex === undefined) return;
  const index = Number(catIndex);
  if (Number.isNaN(index)) return;
  const tbody = document.querySelector(`#table_${index} tbody`);
  if (!tbody) return;
  const selects = Array.from(tbody.querySelectorAll('.task-select'));
  const used = new Set();
  selects.forEach(sel => {
    const val = sel.value;
    if (val && val !== 'Other'){
      used.add(val);
    }
  });
  selects.forEach(sel => {
    const currentVal = sel.value;
    const placeholderSelected = currentVal ? '' : ' selected';
    const options = [`<option value="" disabled${placeholderSelected}>-- Select --</option>`];
    categories[index].tasks.forEach(task => {
      if (task === 'Other' || task === currentVal || !used.has(task)){
        const selected = currentVal === task ? ' selected' : '';
        options.push(`<option value="${task}"${selected}>${task}</option>`);
      }
    });
    sel.innerHTML = options.join('');
    if (currentVal === 'Other'){
      sel.classList.add('other-hidden');
    } else {
      sel.classList.remove('other-hidden');
    }
  });
}

function saveState(){
  if (isRestoring) return;
  try{
    const payload = categories.map((_, idx) => {
      const tbody = document.querySelector(`#table_${idx} tbody`);
      if (!tbody) return [];
      return Array.from(tbody.querySelectorAll('tr')).map(tr => ({
        task: tr.querySelector('.task-select')?.value || '',
        other: tr.querySelector('.other-task')?.value || '',
        before: tr.querySelector('td:nth-child(2) input')?.value || '',
        current: tr.querySelector('td:nth-child(3) input')?.value || ''
      }));
    });
    localStorage.setItem(storageKey, JSON.stringify(payload));
  } catch(err){
    // Ignore storage failures (private mode, quota exceeded, etc.)
  }
}

function restoreState(){
  let stored;
  try{
    stored = localStorage.getItem(storageKey);
    if (!stored) return false;
  } catch(err){
    return false;
  }
  let data;
  try{
    data = JSON.parse(stored);
  } catch(err){
    return false;
  }
  if (!Array.isArray(data)) return false;

  isRestoring = true;
  categories.forEach((_, catIndex) => {
    const rowsData = Array.isArray(data[catIndex]) ? data[catIndex] : [];
    const tbody = document.querySelector(`#table_${catIndex} tbody`);
    if (!tbody) return;
    const targetLength = Math.max(1, rowsData.length);
    while (tbody.rows.length < targetLength){
      appendTaskRow(catIndex);
    }
    while (tbody.rows.length > targetLength && tbody.rows.length > 1){
      tbody.removeChild(tbody.lastElementChild);
    }
    const rows = Array.from(tbody.querySelectorAll('tr'));
    if (!rowsData.length){
      rows.forEach(resetTaskRow);
      updateTaskOptions(catIndex);
      return;
    }
    rows.forEach((tr, idx) => {
      const rowData = rowsData[idx];
      if (!rowData){
        resetTaskRow(tr);
        return;
      }
      const select = tr.querySelector('.task-select');
      if (select){
        select.value = rowData.task || '';
        select.dispatchEvent(new Event('change', { bubbles: true }));
      }
      const other = tr.querySelector('.other-task');
      if (other){
        other.value = rowData.other || '';
        if (select && select.value === 'Other'){
          other.disabled = false;
          other.classList.add('is-active');
          select.classList.add('other-hidden');
        }
      }
      const lower = (select?.value || '').toLowerCase();
      const disablePair = lower.includes('no difficulties') || lower.includes('no restriction');
      const beforeInput = tr.querySelector('td:nth-child(2) input');
      if (beforeInput){
        beforeInput.value = rowData.before || (disablePair ? '-' : '');
        beforeInput.disabled = disablePair;
      }
      const currentInput = tr.querySelector('td:nth-child(3) input');
      if (currentInput){
        currentInput.value = rowData.current || (disablePair ? '-' : '');
        currentInput.disabled = disablePair;
      }
      tr.classList.toggle('disabled-row', disablePair);
    });
    updateTaskOptions(catIndex);
  });
  isRestoring = false;
  saveState();
  return true;
}

const container = document.getElementById('tables-container');

categories.forEach((cat,catIndex)=>{
  const div = document.createElement('div');
  div.innerHTML = `
    <h2>${cat.name}</h2>
    <table id="table_${catIndex}">
      <thead>
        <tr>
          <th>Task</th>
          <th>Before the Accident</th>
          <th>Now</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        ${rowTemplate(catIndex, 1)}
      </tbody>
    </table>
    <button type="button" class="add-row" data-cat="${catIndex}">+ Add New Task</button>
  `;
  container.appendChild(div);
  updateTaskOptions(catIndex);
});

document.addEventListener('change', function(e){
  if(e.target.classList.contains('task-select')){
    const tr = e.target.closest('tr');
    const inputOther = e.target.nextElementSibling;
    const beforeInput = tr.querySelector('td:nth-child(2) input');
    const currentInput = tr.querySelector('td:nth-child(3) input');

    const value = e.target.value;

    if (inputOther) {
      if (value === 'Other') {
        inputOther.disabled = false;
        inputOther.classList.add('is-active');
        e.target.classList.add('other-hidden');
        requestAnimationFrame(() => inputOther.focus());
      } else {
        inputOther.value = '';
        inputOther.disabled = true;
        inputOther.classList.remove('is-active');
        e.target.classList.remove('other-hidden');
      }
    }

    const lower = value.toLowerCase();
    const disablePair = lower.includes('no difficulties') || lower.includes('no restriction');
    if(disablePair){
      if (beforeInput){
        beforeInput.value = '-';
        beforeInput.disabled = true;
      }
      if (currentInput){
        currentInput.value = '-';
        currentInput.disabled = true;
      }
      tr.classList.add('disabled-row');
      e.target.classList.remove('other-hidden');
    } else {
      if (beforeInput){
        beforeInput.disabled = false;
      }
      if (currentInput){
        currentInput.disabled = false;
      }
      tr.classList.remove('disabled-row');
    }
    const catIndex = getCatIndexFromName(e.target.name);
    if (!isRestoring){
      updateTaskOptions(catIndex);
      saveState();
    }
  }
});

document.addEventListener('click', function(e){
  if(e.target.classList.contains('add-row')){
    const catIndex = Number(e.target.dataset.cat);
    appendTaskRow(catIndex);
    updateTaskOptions(catIndex);
    if (!isRestoring) saveState();
  }
});

document.addEventListener('click', function(e){
  const btn = e.target.closest('.delete-row');
  if(!btn) return;
  const tr = btn.closest('tr');
  if(!tr) return;
  const select = tr.querySelector('.task-select');
  const catIndex = select ? getCatIndexFromName(select.name) : null;
  const tbody = tr.parentElement;
  const rows = tbody.querySelectorAll('tr');
  if(rows.length > 1){
    tr.remove();
  } else {
    resetTaskRow(tr);
  }
  updateTaskOptions(catIndex);
  if (!isRestoring) saveState();
});

document.addEventListener('input', function(e){
  if (e.target.matches('input')){
    if (!isRestoring) saveState();
  }
});

if (!restoreState()){
  saveState();
}
</script>

</body>
</html>
