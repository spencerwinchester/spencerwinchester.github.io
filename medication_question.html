<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Medication Form</title>
<style>
  html, body {
    font-family: Arial, sans-serif;
    background: #ffffff;
    margin: 0;
    width: 760px;
    max-width: 760px;
    overflow-x: hidden;
  }
  .form-wrapper { width: 760px; max-width: 760px; margin: 0 auto; padding: 0; box-sizing: border-box; }
  table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 2px; 
    table-layout: fixed;
    margin-bottom: 15px;
  }
  th, td {
    border: none;
    padding: 6px 2px; 
    width: calc(100% / 8);
    word-wrap: break-word;
    overflow-wrap: anywhere;
    white-space: normal;
    position: relative; 
  }
  td { text-align: left; }
  th {
    background: transparent;
    color: #5f6b7a; 
    font-weight: 600;
    text-align: left;
    font-size: 14px;
    overflow-wrap: break-word;
    line-height: 1.25;
  }
  select, input, textarea {
    width: 100%;
    display: block; /* ensure full-width in cells */
    padding: 8px 10px;
    box-sizing: border-box;
    background: #fff;
    border: 1px solid #d0d7de; /* light border */
    border-radius: 6px;
    color: #111827;
  }
  select:focus, input:focus, textarea:focus {
    outline: none;
    border-color: #1c75bc;
    box-shadow: 0 0 0 3px rgba(28, 117, 188, 0.15);
  }
  .error {
    border-color: #dc2626 !important; 
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.15) !important;
  }
  .inline-tooltip {
    display: none;
    position: absolute;
    top: -4px;
    right: 0;
    background: #656a74;
    color: #fff;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    line-height: 1.2;
    white-space: nowrap;
    z-index: 5;
  }
  .other-input, .dosage-text {
    display: none;
  }
  .other-input.is-active,
  .dosage-text.is-active {
    display: block;
    position: absolute;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
    width: 100%;
    z-index: 2;
  }
  select.other-hidden {
    visibility: hidden;
  }
  .dosage-text { margin-top: 0; }
  .placeholder {
    display: none;
    color: #6b7280;
  }
  td.disabled-field {
    background: #f3f4f6;
  }
  td.disabled-field select,
  td.disabled-field input,
  td.disabled-field textarea {
    display: none !important;
  }
  td.disabled-field .placeholder {
    display: block;
  }
  .add-btn {
    background: #1c75bc;
    color: white;
    border: none;
    padding: 10px 15px;
    cursor: pointer;
    margin-top: 10px;
    border-radius: 4px;
  }
  td.actions { display: flex; align-items: center; justify-content: center; padding: 6px 0; }
  .delete-btn {
    background: #dc3545;
    color: #fff;
    border: none;
    padding: 0;
    cursor: pointer;
    border-radius: 6px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    box-sizing: border-box;
    margin: 0;
  }
  .delete-btn svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
  }
  </style>
</head>
<body>

<div class="form-wrapper">
<form id="medForm">
  <table id="medTable">
    <thead>
      <tr>
        <th>Name of medication:</th>
        <th>When did you first take the medication?</th>
        <th>What dose did you take?</th>
        <th>How often did you take it?</th>
        <th>For how long did you take it?</th>
        <th>Why were you taking it?</th>
        <th>How well did it work?</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>
          <select class="medication" name="medication[]">
            <option value="">-- Select --</option>
            <option value="Paracetamol (Panadol, Tylenol, Acetaminophen)">Paracetamol (Panadol, Tylenol, Acetaminophen)</option>
            <option value="Ibuprofen (Nurofen, Advil, Brufen)">Ibuprofen (Nurofen, Advil, Brufen)</option>
            <option value="Codeine">Codeine</option>
            <option value="Panadeine Forte (Paracetamol + Codeine, Panadeine)">Panadeine Forte (Paracetamol + Codeine, Panadeine)</option>
            <option value="Oxycodone (Endone)">Oxycodone (Endone)</option>
            <option value="Tramadol (Tramal, Zydol)">Tramadol (Tramal, Zydol)</option>
            <option value="Morphine (MS Contin, Kapanol, Morphgesic, Avinza)">Morphine (MS Contin, Kapanol, Morphgesic, Avinza)</option>
            <option value="Aspirin - Disprin, Cartia, Ecotrin, Acetylsalicylic Acid">Aspirin - Disprin, Cartia, Ecotrin, Acetylsalicylic Acid</option>
            <option value="Diclofenac - Voltaren, Cataflam">Diclofenac - Voltaren, Cataflam</option>
            <option value="Do not recall">Do not recall</option>
            <option value="Other">Other</option>
          </select>
          <input type="text" class="other-input medication-other" name="medication_other[]" placeholder="Please specify medication" disabled />
        </td>
        <td data-lockable>
          <select class="time-after" name="time_after_accident[]">
            <option value="">-- Select --</option>
            <option value="Within 1 hour">Within 1 hour</option>
            <option value="Within 2-3 hours">Within 2-3 hours</option>
            <option value="4-6 hours later">4-6 hours later</option>
            <option value="7-12 hours later">7-12 hours later</option>
            <option value="12-24 hours later">12-24 hours later</option>
            <option value="The following day">The following day</option>
            <option value="2 days later">2 days later</option>
            <option value="3-5 days later">3-5 days later</option>
            <option value="More than 5 days later">More than 5 days later</option>
            <option value="Unsure">Unsure</option>
          </select>
          <span class="placeholder" aria-hidden="true">-</span>
        </td>
        <td data-lockable>
          <select class="dosage" name="dosage[]">
            <option value="">-- Select --</option>
          </select>
          <input type="text" class="dosage-text" name="dosage_text[]" placeholder="Please specify dosage" disabled>
          <span class="placeholder" aria-hidden="true">-</span>
        </td>
        <td data-lockable>
          <select name="frequency[]">
            <option value="">-- Select --</option>
            <option value="Once only">Once only</option>
            <option value="As needed">As needed</option>
            <option value="Every 4-6 hours">Every 4-6 hours</option>
            <option value="Once per day">Once per day</option>
            <option value="Twice per day (morning and night)">Twice per day (morning and night)</option>
            <option value="Three times per day">Three times per day</option>
            <option value="Four times per day">Four times per day</option>
            <option value="Other">Other</option>
            <option value="Unsure">Unsure</option>
          </select>
          <input type="text" class="other-input frequency-other" name="frequency_other[]" placeholder="Please specify frequency" disabled />
          <span class="placeholder" aria-hidden="true">-</span>
        </td>
        <td data-lockable>
          <select class="duration" name="duration[]">
            <option value="">-- Select --</option>
            <option value="One day">One day</option>
            <option value="Two days">Two days</option>
            <option value="Three days">Three days</option>
            <option value="Four-seven days">Four-seven days</option>
            <option value="More than one week">More than one week</option>
            <option value="More than two weeks">More than two weeks</option>
            <option value="More than one month">More than one month</option>
            <option value="Ongoing">Ongoing</option>
            <option value="Other">Other</option>
            <option value="Unsure">Unsure</option>
          </select>
          <input type="text" class="other-input duration-other" name="duration_other[]" placeholder="Please specify duration" disabled />
          <span class="placeholder" aria-hidden="true">-</span>
        </td>
        <td data-lockable>
          <select class="reason" name="reason[]">
            <option value="">-- Select --</option>
            <option value="Pain relief">Pain relief</option>
            <option value="Inflammation reduction">Inflammation reduction</option>
            <option value="To aid sleep">To aid sleep</option>
            <option value="Reduce anxiety or stress">Reduce anxiety or stress</option>
            <option value="Other">Other</option>
          </select>
          <input type="text" class="other-input reason-other" name="reason_other[]" placeholder="Please specify reason" disabled />
          <span class="placeholder" aria-hidden="true">-</span>
        </td>
        <td data-lockable>
          <select class="effectiveness" name="effectiveness[]">
            <option value="">-- Select --</option>
            <option value="Very effective">Very effective</option>
            <option value="Moderately effective">Moderately effective</option>
            <option value="Slightly effective">Slightly effective</option>
            <option value="Not effective">Not effective</option>
            <option value="Unsure">Unsure</option>
          </select>
          <span class="placeholder" aria-hidden="true">-</span>
        </td>
        <td class="actions">
          <button type="button" class="delete-btn" onclick="deleteRow(this)" aria-label="Delete row">
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
              <path d="M9 3a1 1 0 0 0-.894.553L7.382 5H5a1 1 0 1 0 0 2h14a1 1 0 1 0 0-2h-2.382l-.724-1.447A1 1 0 0 0 14.999 3H9Zm-3 6v10a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V9H6Zm4 2a1 1 0 0 1 2 0v8a1 1 0 1 1-2 0v-8Zm4-1a1 1 0 0 1 1 1v8a1 1 0 1 1-2 0v-8a1 1 0 0 1 1-1Z"/>
            </svg>
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <button type="button" class="add-btn" onclick="addRow()">+ Add Another Medication</button>
</form>
</div>

<script>
// Medication â†’ Dosage map
const dosageMap = {
  "Paracetamol (Panadol, Tylenol, Acetaminophen)": [
    "-- Select --",
    "500mg (1 tablet)",
    "1000mg (2 tablets)",
    "More than 1000mg (More than 2 tablets)",
    "Unsure"
  ],
  "Ibuprofen (Nurofen, Advil, Brufen)": [
    "-- Select --",
    "200mg (1 tablet)",
    "400mg (2 tablets)",
    "More than 400mg (More than 2 tablets)",
    "Unsure"
  ],
  "Codeine": [
    "-- Select --",
    "15mg",
    "30mg",
    "60mg",
    "More than 60mg"
  ],
  "Panadeine Forte (Paracetamol + Codeine, Panadeine)": [
    "-- Select --",
    "500mg/30mg (1 tablet)",
    "1000mg/60mg (2 tablets)",
    "More than 1000mg/60mg"
  ],
  "Oxycodone (Endone)": [
    "-- Select --",
    "5mg",
    "10mg",
    "15mg",
    "20mg",
    "More than 20mg",
    "Unsure"
  ],
  "Tramadol (Tramal, Zydol)": [
    "-- Select --",
    "25mg",
    "50mg",
    "75mg",
    "100mg",
    "More than 100mg",
    "Unsure"
  ],
  "Morphine (MS Contin, Kapanol, Morphgesic, Avinza)": [
    "-- Select --",
    "10 milligrams",
    "15 milligrams",
    "30 milligrams",
    "More than 30 milligrams",
    "Unsure"
  ],
  "Aspirin - Disprin, Cartia, Ecotrin, Acetylsalicylic Acid": [
    "-- Select --",
    "100mg (1 low strength tablet)",
    "300mg (1 regular strength tablet)",
    "500mg (1 high strength tablet)",
    "600mg (2 regular strength tablets)",
    "900mg (3 regular strength tablets)",
    "1000mg (2 high strength tablets)",
    "More than 1000mg"
  ],
  "Diclofenac - Voltaren, Cataflam": [
    "-- Select --",
    "12.5mg (1 low strength tablet)",
    "25mg (2 low strength tablets/1 medium strength tablet)",
    "50mg (2 low strength tablets/1 high strength tablet)",
    "100mg (2 high strength tablets)",
    "1% (Topical Gel 11.6mg/g)",
    "2% (Topical Gel 23.2mg/g)"
  ],
  "Other": ["-- Select --"]
};

// Update dosage dropdown when medication changes
function updateDosage(select) {
  const row = select.closest("tr");
  if (!row) return;
  const med = select.value;
  const dosageSelect = row.querySelector(".dosage");
  if (!dosageSelect) return;
  const dosageInput = row.querySelector(".dosage-text");
  const useTextInput = med === 'Other';

  if (dosageInput) {
    if (useTextInput) {
      dosageSelect.classList.add('other-hidden');
      dosageSelect.tabIndex = -1;
      dosageSelect.name = '';
      dosageSelect.innerHTML = '<option value="">-- Select --</option>';
      dosageInput.classList.add('is-active');
      dosageInput.disabled = false;
      dosageInput.name = 'dosage[]';
      dosageInput.focus();
    } else {
      dosageInput.classList.remove('is-active');
      dosageInput.value = '';
      dosageInput.disabled = true;
      dosageInput.name = 'dosage_text[]';
      dosageSelect.classList.remove('other-hidden');
      dosageSelect.tabIndex = 0;
      if (!dosageSelect.name) dosageSelect.name = 'dosage[]';
    }
  }

  if (useTextInput) {
    dosageSelect.classList.remove('error');
    const tdText = dosageSelect.closest('td');
    if (tdText) {
      const tip = tdText.querySelector('.inline-tooltip');
      if (tip) tip.style.display = 'none';
    }
    return;
  }

  dosageSelect.innerHTML = "";

  if (dosageMap[med]) {
    dosageMap[med].forEach(dose => {
      let opt = document.createElement("option");
      opt.value = dose;
      opt.textContent = dose;
      dosageSelect.appendChild(opt);
    });
  } else {
    let opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "-- Select --";
    dosageSelect.appendChild(opt);
  }

  // clear any previous error state/tooltip on dosage when medication changes
  dosageSelect.classList.remove('error');
  const td = dosageSelect.closest('td');
  if (td) {
    const tip = td.querySelector('.inline-tooltip');
    if (tip) tip.style.display = 'none';
  }
  syncDeleteButtonSizes();
}

function syncDeleteButtonSizes() {
  const rows = document.querySelectorAll('#medTable tbody tr');
  if (!rows.length) return;
  const headerCell = document.querySelector('#medTable thead th:last-child');
  requestAnimationFrame(() => {
    let latestSize = null;
    rows.forEach(row => {
      const btn = row.querySelector('.delete-btn');
      const ref = row.querySelector('.medication');
      if (!btn || !ref) return;
      const height = ref.offsetHeight;
      if (!height) return;
      btn.style.height = `${height}px`;
      btn.style.width = `${height}px`;
      const actionsCell = btn.closest('td.actions');
      if (actionsCell) {
        actionsCell.style.width = `${height + 2}px`;
      }
      latestSize = height;
    });
    if (headerCell && latestSize !== null) {
      headerCell.style.width = `${latestSize + 2}px`;
    }
  });
}

// Tooltip helper
function showTooltipFor(el, message) {
  const cell = el.closest('td');
  if (!cell) return;
  let tip = cell.querySelector('.inline-tooltip');
  if (!tip) {
    tip = document.createElement('div');
    tip.className = 'inline-tooltip';
    cell.appendChild(tip);
  }
  tip.textContent = message;
  tip.style.display = 'block';
  clearTimeout(tip._hideT);
  tip._hideT = setTimeout(() => {
    tip.style.display = 'none';
    // also clear error highlight when tooltip goes away
    if (el && el.classList) el.classList.remove('error');
  }, 2000);
}

// Show/hide free-text inputs when "Other" is selected
function toggleOther(selectEl, inputEl) {
  if (!selectEl || !inputEl) return;
  const show = selectEl.value === 'Other';
  if (show) {
    inputEl.disabled = false;
    inputEl.classList.add('is-active');
    selectEl.classList.add('other-hidden');
    selectEl.tabIndex = -1;
    requestAnimationFrame(() => inputEl.focus());
  } else {
    inputEl.value = '';
    inputEl.disabled = true;
    inputEl.classList.remove('is-active');
    selectEl.classList.remove('other-hidden');
    selectEl.tabIndex = 0;
  }
  syncDeleteButtonSizes();
}

function setDoNotRecallState(row, shouldLock) {
  if (!row) return;
  const lockableCells = row.querySelectorAll('[data-lockable]');
  lockableCells.forEach(cell => {
    cell.classList.toggle('disabled-field', shouldLock);
    const controls = cell.querySelectorAll('select, input, textarea');
    controls.forEach(control => {
      control.disabled = shouldLock;
      control.classList.remove('error');
      if (shouldLock) {
        if (control.tagName === 'SELECT') {
          control.selectedIndex = 0;
          control.classList.remove('other-hidden');
          control.tabIndex = 0;
        } else {
          control.value = '';
        }
        if (control.classList.contains('other-input')) {
          control.classList.remove('is-active');
          control.disabled = true;
          const relatedSelect = cell.querySelector('select');
          if (relatedSelect) {
            relatedSelect.classList.remove('other-hidden');
            relatedSelect.tabIndex = 0;
          }
        }
        if (control.classList.contains('dosage-text')) {
          control.classList.remove('is-active');
          control.disabled = true;
          control.name = 'dosage_text[]';
        }
      }
    });

    if (!shouldLock) {
      const select = cell.querySelector('select');
      const otherField = cell.querySelector('.other-input');
      if (select && otherField) {
        toggleOther(select, otherField);
      }
    }

    const tip = cell.querySelector('.inline-tooltip');
    if (tip) tip.style.display = 'none';
  });
  syncDeleteButtonSizes();
}

function bindConditionalOtherRow(row) {
  const freqSelect = row.querySelector('select[name="frequency[]"]');
  const freqOther = row.querySelector('input.frequency-other');
  if (freqSelect && freqOther) {
    freqSelect.addEventListener('change', () => toggleOther(freqSelect, freqOther));
    toggleOther(freqSelect, freqOther);
  }

  const durationSelect = row.querySelector('select.duration');
  const durationOther = row.querySelector('input.duration-other');
  if (durationSelect && durationOther) {
    durationSelect.addEventListener('change', () => toggleOther(durationSelect, durationOther));
    toggleOther(durationSelect, durationOther);
  }

  const reasonSelect = row.querySelector('select.reason');
  const reasonOther = row.querySelector('input.reason-other');
  if (reasonSelect && reasonOther) {
    reasonSelect.addEventListener('change', () => toggleOther(reasonSelect, reasonOther));
    toggleOther(reasonSelect, reasonOther);
  }
}

function bindMedicationRow(row) {
  if (!row) return;
  const medSelect = row.querySelector('.medication');
  if (!medSelect) return;
  const medOther = row.querySelector('.medication-other');

  const handleMedicationChange = () => {
    const isDoNotRecall = medSelect.value === 'Do not recall';
    setDoNotRecallState(row, isDoNotRecall);

    if (!isDoNotRecall) {
      updateDosage(medSelect);
    }

    if (medOther) toggleOther(medSelect, medOther);
  };

  medSelect.addEventListener('change', handleMedicationChange);
  handleMedicationChange();
  syncDeleteButtonSizes();
}

const firstRow = document.querySelector('#medTable tbody tr');
bindMedicationRow(firstRow);

// Bind conditional "Other" inputs on the first row
bindConditionalOtherRow(firstRow);

// Guard dosage selection until medication chosen
function bindDosageGuard(row) {
  const medSel = row.querySelector('.medication');
  const doseSel = row.querySelector('.dosage');
  if (!doseSel) return;
  doseSel.addEventListener('mousedown', (e) => {
    if (medSel && !medSel.value) {
      e.preventDefault();
      doseSel.blur();
      doseSel.classList.add('error');
      showTooltipFor(doseSel, 'Select medication first');
    }
  });
}

// Bind guard on initial row
bindDosageGuard(firstRow);

// Add new row
  function addRow() {
  const tableBody = document.getElementById("medTable").querySelector("tbody");
  const firstRow = tableBody.querySelector("tr");
  const newRow = firstRow.cloneNode(true);

  // Clear values
  newRow.querySelectorAll("input, textarea").forEach(el => el.value = "");
  const newDosageSelect = newRow.querySelector(".dosage");
  if (newDosageSelect) {
    newDosageSelect.innerHTML = "<option value=\"\">-- Select --</option>";
    newDosageSelect.classList.remove('other-hidden');
    newDosageSelect.tabIndex = 0;
    newDosageSelect.name = 'dosage[]';
  }
  newRow.querySelector(".medication").value = "";
  const timeSelect = newRow.querySelector(".time-after");
  if (timeSelect) timeSelect.value = "";
  const freqSelect = newRow.querySelector('select[name="frequency[]"]');
  if (freqSelect) freqSelect.value = "";
  const durationSelect = newRow.querySelector('.duration');
  if (durationSelect) durationSelect.value = "";
  const reasonSelect = newRow.querySelector('.reason');
  if (reasonSelect) reasonSelect.value = "";

  // Hide and clear any "Other" text inputs
  newRow.querySelectorAll('.other-input').forEach(input => {
    input.value = '';
    input.disabled = true;
    input.classList.remove('is-active');
    const relatedSelect = input.closest('td') ? input.closest('td').querySelector('select') : null;
    if (relatedSelect) {
      relatedSelect.classList.remove('other-hidden');
      relatedSelect.tabIndex = 0;
    }
  });
  const newDosageInput = newRow.querySelector('.dosage-text');
  if (newDosageInput) {
    newDosageInput.classList.remove('is-active');
    newDosageInput.disabled = true;
    newDosageInput.name = 'dosage_text[]';
  }
  const effectivenessSelect = newRow.querySelector('.effectiveness');
  if (effectivenessSelect) effectivenessSelect.value = "";

  // Rebind medication change listener and related toggles
  bindMedicationRow(newRow);

  // Bind conditional Other toggles for the new row
  bindConditionalOtherRow(newRow);

  // Bind dosage guard for the new row
  bindDosageGuard(newRow);

  tableBody.appendChild(newRow);
  syncDeleteButtonSizes();
  }

  // Delete a row; if it's the only row, just clear it
  function deleteRow(btn) {
    const row = btn.closest('tr');
    const tbody = document.querySelector('#medTable tbody');
    if (!row || !tbody) return;
    const rows = tbody.querySelectorAll('tr');
    if (rows.length > 1) {
      row.remove();
      syncDeleteButtonSizes();
      return;
    }
    // If only one row remains, reset/clear it
    // Ensure fields are unlocked
    setDoNotRecallState(row, false);

    // Reset selects
    row.querySelectorAll('select').forEach(sel => {
      sel.classList.remove('error');
      if (sel.classList.contains('dosage')) {
        sel.innerHTML = '<option value="">-- Select --</option>';
        sel.classList.remove('other-hidden');
        sel.tabIndex = 0;
        sel.name = 'dosage[]';
      } else {
        sel.value = '';
      }
    });

    // Reset inputs/textareas and hide any "Other" inputs
    row.querySelectorAll('input, textarea').forEach(el => {
      el.classList.remove('error');
      el.value = '';
      if (el.classList.contains('other-input')) {
        el.classList.remove('is-active');
        el.disabled = true;
        const relatedSelect = el.closest('td') ? el.closest('td').querySelector('select') : null;
        if (relatedSelect) {
          relatedSelect.classList.remove('other-hidden');
          relatedSelect.tabIndex = 0;
        }
      }
      if (el.classList.contains('dosage-text')) {
        el.classList.remove('is-active');
        el.disabled = true;
        el.name = 'dosage_text[]';
      }
    });

    // Hide any inline tooltips
    row.querySelectorAll('.inline-tooltip').forEach(t => { t.style.display = 'none'; });
    syncDeleteButtonSizes();
  }

window.addEventListener('load', syncDeleteButtonSizes);
window.addEventListener('resize', syncDeleteButtonSizes);
</script>

</body>
</html>
